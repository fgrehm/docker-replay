#!/bin/bash

# set -x

# TODO:
#   - [x] Prepare the new Dockerfile
#   - [x] Write to temp file
#   - [x] LABEL new instructions
#   - [x] Rebuild it indefinitely
#   - [ ] Validate the base image (ex: does it have ONBUILD instructions?)
#
# NICE TO HAVES:
#   - [ ] Allow other LABELS to be applied to the images

# Soon to be arguments passed on to the CLI
IMAGE_NAME='remove-docker-rebuilt'
BUILD_TIMESTAMP=$(date +%Y%m%d%H%M%S)

declare -a ONBUILDS

for IMG_ID in $(docker history $IMAGE_NAME | grep -i onbuild | cut -f1 -d' '); do
  LABELS=$(docker inspect -f "{{json .ContainerConfig.Labels }}" $IMG_ID)
  if [ "${LABELS}" = '{}' ]; then
    ONBUILDS=("${IMG_ID}" "${ONBUILDS[@]}")
  else
    break
  fi
done

OUTPUT_FILE=$(mktemp)
cat <<-STR > $OUTPUT_FILE
# Automatically generated by docker-ronbuild, you can safely delete this file
FROM ${IMAGE_NAME}:latest
LABEL rebuilt-at='${BUILD_TIMESTAMP}'
STR

# REFACTOR: This can be cleaned up
docker inspect -f "{{json .ContainerConfig.OnBuild }}" "${ONBUILDS[@]}" | jq -r '.[. | length - 1] | .' \
  | while read CMD; do
  echo $CMD >> $OUTPUT_FILE
done

echo $OUTPUT_FILE
cat $OUTPUT_FILE

mv $OUTPUT_FILE `pwd`/examples

docker build -t $IMAGE_NAME -f examples/$(basename "${OUTPUT_FILE}") examples/.

rm `pwd`/examples/$(basename "${OUTPUT_FILE}")
