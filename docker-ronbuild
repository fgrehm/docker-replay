#!/bin/bash

# set -x

# TODO:
#   - [x] Prepare the new Dockerfile
#   - [x] Write to temp file
#   - [ ] Rebuild it indefinitely
#   - [ ] Validate the base image (ex: does it have ONBUILD instructions?)

# Soon to be arguments passed on to the CLI
IMAGE_NAME='remove-docker-replay-test'

declare -a ONBUILDS

for IMG_ID in $(docker history $IMAGE_NAME | grep -i onbuild | cut -f1 -d' '); do
  LABELS=$(docker inspect -f "{{json .ContainerConfig.Labels }}" $IMG_ID)
  if [ "${LABELS}" = '{}' ]; then
    ONBUILDS=("${ONBUILDS[@]}" "${IMG_ID}")
  else
    break
  fi
done

OUTPUT_FILE=$(mktemp)
cat <<-STR > $OUTPUT_FILE
# Automatically generated by docker-ronbuild, you can safely delete this file
FROM ${IMAGE_NAME}:latest
$(docker inspect -f "{{json .ContainerConfig.OnBuild }}" "${ONBUILDS[@]}" | jq -r '.[. | length - 1] | .')
STR

echo $OUTPUT_FILE
cat $OUTPUT_FILE
